# SECURITY FIX: Search Limit Exploit Patched

## Critical Vulnerability Fixed

### The Exploit
Users could bypass the 5 search/24hr limit by:
1. Logging out and logging back in
2. Deleting and reinstalling the extension
3. Clearing browser storage

### Root Cause
The extension was using **local storage as a fallback** instead of enforcing **backend-only tracking** for logged-in users.

**Vulnerable Code (popup.js:820-863):**
```javascript
// OLD CODE - EXPLOITABLE
async checkSearchUsage() {
    // Problem 1: Checked local isPremium flags before backend
    if (this.isPremium || storage.isPremium || storage.isPro) {
        return { count: 0, canSearch: true };
    }

    // Problem 2: Fell back to local storage if no email
    if (!userEmail) {
        return await this.checkSearchUsageLocal(); // EXPLOITABLE
    }

    // Problem 3: Fell back to local storage if API failed
    if (!response.ok) {
        return await this.checkSearchUsageLocal(); // EXPLOITABLE
    }

    // Problem 4: Recalculated canSearch locally instead of trusting backend
    const canSearch = count < 5; // WRONG - ignores backend logic
}
```

## Security Fixes Applied

### 1. Backend-Only Enforcement
- **REMOVED** local storage fallback for logged-in users
- **REMOVED** local isPremium checks (backend is source of truth)
- **BLOCKS** searches completely if backend API fails (fail-secure)

### 2. Trust Backend Completely
```javascript
// NEW CODE - SECURE
async checkSearchUsage() {
    // Require login for searches
    if (!userEmail) {
        return { count: 5, canSearch: false }; // BLOCKED
    }

    // Always check backend - NO fallback
    const response = await fetch(CONFIG.API.CHECK_SEARCH_USAGE, ...);

    if (!response.ok) {
        return { count: 5, canSearch: false }; // BLOCKED on error
    }

    // Use backend's canSearch directly - DON'T recalculate
    const canSearch = data.canSearch !== undefined ? data.canSearch : false;
}
```

### 3. Backend-Only Increment
```javascript
// NEW CODE - SECURE
async incrementSearchUsage() {
    // REMOVED local storage increment
    // ONLY record on backend
    // THROW error if backend fails (prevents silent failures)

    if (!response.ok) {
        throw new Error('Backend sync failed'); // Fail loudly
    }
}
```

## Testing the Fix

### Before Fix (Exploitable)
1. Use 5 searches
2. Logout → Login
3. Result: 5/5 searches restored

### After Fix (Secure)
1. Use 5 searches → Backend records all 5
2. Logout → Backend data persists
3. Login → Backend returns canSearch=false
4. Result: Cannot search (limit enforced)

### Test Commands
```bash
# Test 1: Use all 5 searches
for i in {1..5}; do
  curl -X POST https://tabmangment.com/api/increment-search \
    -H "Content-Type: application/json" \
    -d '{"email":"testuser@example.com"}'
done

# Test 2: Check limit is enforced
curl -X POST https://tabmangment.com/api/check-search-usage \
  -H "Content-Type: application/json" \
  -d '{"email":"testuser@example.com"}'
# Should return: {"canSearch":false,"searchCount":5}

# Test 3: Logout/login doesn't reset (extension now checks backend)
# Extension will fetch from backend and get canSearch=false
```

## Security Guarantees

### For Free Users
- 5 searches per 24 hours (rolling window)
- Tracked in Supabase backend
- Cannot be bypassed by:
  - Logging out/in
  - Reinstalling extension
  - Clearing browser storage
  - Switching browsers (same email)

### For Pro Users
- Unlimited searches
- Verified via backend `isPro` flag
- Cannot be spoofed locally

## Backend API Endpoints

### POST /api/check-search-usage
```json
Request: {"email": "user@example.com"}
Response: {
  "success": true,
  "searchCount": 3,
  "canSearch": true,
  "remaining": 2,
  "resetsAt": "2025-11-06T04:21:16.917Z",
  "isPro": false
}
```

### POST /api/increment-search
```json
Request: {"email": "user@example.com"}
Response: {
  "success": true,
  "searchCount": 4,
  "remaining": 1,
  "limitReached": false,
  "isPro": false
}
```

## Files Modified
- `/popup.js` (lines 820-917)
- `/extension-build/popup.js`
- `/chrome-store-build/popup.js`

## Deployment
To deploy the fix:
1. Test the extension locally
2. Commit changes: `git add popup.js extension-build/ chrome-store-build/`
3. Push to GitHub: `git push`
4. Update Chrome Web Store listing with new build

## Notes
- The `checkSearchUsageLocal()` function still exists but is NEVER called for logged-in users
- It only exists as a safeguard for edge cases where a user somehow isn't logged in
- Local storage is NO LONGER used for tracking logged-in users
- All tracking is 100% backend-enforced via Supabase

---

**Security Status:** PATCHED
**Date:** 2025-11-05
**Impact:** High (prevented unlimited search exploit)
